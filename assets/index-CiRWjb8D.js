const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StoryModel-BXXMG2xb.js","assets/DbService-BL4Dz8du.js","assets/HomeView-nyegfGjc.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=r(a);fetch(a.href,n)}})();const E="modulepreload",k=function(e){return"/proyek-akhir/"+e},y={},c=function(t,r,o){let a=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),i=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=Promise.allSettled(r.map(l=>{if(l=k(l),l in y)return;y[l]=!0;const m=l.endsWith(".css"),f=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${f}`))return;const d=document.createElement("link");if(d.rel=m?"stylesheet":E,m||(d.as="script"),d.crossOrigin="",d.href=l,i&&d.setAttribute("nonce",i),document.head.appendChild(d),m)return new Promise((S,b)=>{d.addEventListener("load",S),d.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return a.then(s=>{for(const i of s||[])i.status==="rejected"&&n(i.reason);return t().catch(n)})},h={performViewTransition:e=>document.startViewTransition?document.startViewTransition(e):(e(),null),showMessage:(e,t,r=!1)=>{const o=document.getElementById("messageModal"),a=document.getElementById("messageModalTitle"),n=document.getElementById("messageModalText"),s=document.getElementById("messageModalClose");if(!o||!a||!n||!s){console.error("Modal elements not found for Utils.showMessage!"),alert(`${e}: ${t}`);return}a.textContent=e,a.className=`modal-title ${r?"modal-title-error":"modal-title-success"}`,a.style.color=r?"#dc3545":"#343a40",n.textContent=t,o.classList.add("active"),s.focus();const i=s.cloneNode(!0);i.textContent="Tutup",i.className="btn btn-primary modal-close-btn",s.parentNode.replaceChild(i,s),i.addEventListener("click",()=>o.classList.remove("active"),{once:!0})},showLoadingSpinner:(e,t="Memuat...")=>{if(!e)return null;e.innerHTML="";const r=h.createElement("div",{class:"loading-indicator-container"}),o=h.createElement("div",{class:"spinner","aria-label":"Loading indicator",role:"status"}),a=h.createElement("p",{class:"loading-text"},[t]);return r.append(o,a),e.appendChild(r),r},hideLoadingSpinner:e=>{if(!e)return;const t=e.querySelector(".loading-indicator-container");t&&t.remove()},createElement:(e,t={},r=[])=>{const o=document.createElement(e);for(const a in t)o.setAttribute(a,t[a]);return r.forEach(a=>{typeof a=="string"?o.appendChild(document.createTextNode(a)):a instanceof Node&&o.appendChild(a)}),o},async base64ToFile(e,t,r){try{const a=await(await fetch(e)).blob();return new File([a],t,{type:r||a.type})}catch(o){throw console.error("Error converting base64 to File:",o),new Error("Gagal memproses gambar.")}},formatDate(e){if(!e)return"Tanggal tidak diketahui";try{return new Date(e).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(t){return console.error(`Gagal memformat tanggal: "${e}"`,t),e}},renderStoryCard:e=>{const t=e.photoUrl||(e.photoBase64?`data:image/jpeg;base64,${e.photoBase64}`:"fallback.jpg"),r=h.formatDate(e.createdAt);return e.lat&&e.lon&&`${e.lat}${e.lon}`,`
      <div class="story-card animate-fade-in">
        <img src="${t}" alt="Foto cerita" loading="lazy" />
        <div class="story-card-body">
          <p class="story-desc">${e.description}</p>
          <p><strong>Tanggal:</strong> ${r}</p>
        </div>
      </div>
    `}},g={API_BASE_URL:"https://story-api.dicoding.dev/v1",TILE_LAYERS:{OpenStreetMap:{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'},SatelitEsri:{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"},GelapCartoDB:{url:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'}},DEFAULT_MAP_CENTER:[-2.5489,118.0149],DEFAULT_MAP_ZOOM:5},w={async register(e){const t=await fetch(`${g.API_BASE_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(t.status>=400||r.error)throw new Error(r.message||"Gagal melakukan registrasi");return r},async login(e){const t=await fetch(`${g.API_BASE_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(t.status>=400||r.error)throw new Error(r.message||"Gagal melakukan login");return r.loginResult},async getStories(e){if(!e)return Promise.reject(new Error("Token tidak tersedia untuk mengambil cerita."));const t=await fetch(`${g.API_BASE_URL}/stories`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),r=t.headers.get("Content-Type"),o=await t.text();if(!t.ok){let n=`Gagal mengambil cerita (${t.status})`;try{n=JSON.parse(o).message||n}catch{}throw new Error(n)}if(!o||!(r!=null&&r.includes("application/json")))throw new Error("Response kosong atau bukan JSON.");return JSON.parse(o).listStory||[]},async addStory(e,t){if(!e)return Promise.reject(new Error("Token tidak tersedia untuk menambah cerita."));const r=await fetch(`${g.API_BASE_URL}/stories`,{method:"POST",headers:{Authorization:`Bearer ${e}`},body:t}),o=await r.json();if(r.status>=400||o.error)throw new Error(o.message||"Gagal menambah cerita baru");return o},async getStoryDetail(e,t){if(!e)return Promise.reject(new Error("Token tidak tersedia."));const r=await fetch(`${g.API_BASE_URL}/stories/${t}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}}),o=await r.json();if(r.status>=400||o.error)throw new Error(o.message||"Gagal mengambil detail cerita");return o.story}},p="storyAppToken",_="storyAppUserName",u={saveToken(e){localStorage.setItem(p,e)},getToken(){return localStorage.getItem(p)},removeToken(){localStorage.removeItem(p)},saveUserName(e){localStorage.setItem(_,e)},getUserName(){return localStorage.getItem(_)},removeUserName(){localStorage.removeItem(_)},isLoggedIn(){return!!this.getToken()}},P={async register(e,t,r){if(!e||!t||!r)throw new Error("Nama, email, dan password tidak boleh kosong.");if(r.length<8)throw new Error("Password minimal harus 8 karakter.");try{return await w.register({name:e,email:t,password:r})}catch(o){throw console.error("AuthModel.register error:",o),o}},async login(e,t){if(!e||!t)throw new Error("Email dan password tidak boleh kosong.");try{const r=await w.login({email:e,password:t});return u.saveToken(r.token),u.saveUserName(r.name),r}catch(r){throw console.error("AuthModel.login error:",r),u.removeToken(),u.removeUserName(),r}},logout(){u.removeToken(),u.removeUserName(),console.log("Pengguna berhasil logout dari AuthModel.")},isUserLoggedIn(){return u.isLoggedIn()},getCurrentUserName(){return u.getUserName()},getCurrentToken(){return u.getToken()}},L={_routes:{},_currentPresenter:null,_mainContentElement:null,_authModel:P,_storyModel:null,_authView:null,_homeView:null,_addStoryView:null,_savedStoriesView:null,_mapService:null,_cameraService:null,async init(e){if(this._mainContentElement=document.getElementById(e),!this._mainContentElement){console.error(`Router init: Elemen konten utama '${e}' tidak ditemukan.`);return}const{default:t}=await c(async()=>{const{default:r}=await import("./AuthView-DBLYBCOI.js");return{default:r}},[]);this._authView=t,this._authView.mainContent=this._mainContentElement,this._routes={login:()=>this._buildAuthPresenter("login"),register:()=>this._buildAuthPresenter("register"),home:()=>this._buildHomePresenter(),"add-story":()=>this._buildAddStoryPresenter(),"saved-stories":()=>this._buildSavedStoriesPresenter(),favorites:()=>this._buildFavoritesPresenter(),logout:()=>this._handleLogoutRoute()},window.addEventListener("hashchange",()=>this._handleRouteChange()),this._handleRouteChange(),this._setupGlobalNavLinks(),this._updateNavbar(),window.addEventListener("online",()=>{console.log("[Router] Online kembali, mencoba sync outbox..."),this._trySyncOutbox().then(()=>{window.location.hash.includes("home")&&this.navigateTo("home")})}),setTimeout(()=>{navigator.onLine&&this._trySyncOutbox().then(()=>{window.location.hash.includes("home")&&this.navigateTo("home")})},500)},async _loadStoryModel(){if(!this._storyModel){const{default:e}=await c(async()=>{const{default:t}=await import("./StoryModel-BXXMG2xb.js");return{default:t}},__vite__mapDeps([0,1]));this._storyModel=e}},async _loadServices(){if(!this._mapService){const{default:e}=await c(async()=>{const{default:t}=await import("./MapService-CXHF154R.js");return{default:t}},[]);this._mapService=e}if(!this._cameraService){const{default:e}=await c(async()=>{const{default:t}=await import("./CameraService-S51gA1ID.js");return{default:t}},[]);this._cameraService=e}},async _buildAuthPresenter(e="login"){const{default:t}=await c(async()=>{const{default:o}=await import("./AuthPresenter-CfdIpfJ1.js");return{default:o}},[]),r=t(this._authModel,this._authView,this);return e==="login"?r.showLoginPage():r.showRegisterPage(),r},async _buildHomePresenter(){if(!this._authModel.isUserLoggedIn())return this.navigateTo("login"),null;if(await this._loadStoryModel(),await this._loadServices(),!this._homeView){const{default:r}=await c(async()=>{const{default:o}=await import("./HomeView-nyegfGjc.js");return{default:o}},__vite__mapDeps([2,1]));this._homeView=r,this._homeView.mainContent=this._mainContentElement}const{default:e}=await c(async()=>{const{default:r}=await import("./HomePresenter-BBNg-AKe.js");return{default:r}},[]),t=e(this._storyModel,this._authModel,this._homeView,this,this._mapService);return await t.showStories(),t},async _buildAddStoryPresenter(){if(!this._authModel.isUserLoggedIn())return this.navigateTo("login"),null;if(await this._loadStoryModel(),await this._loadServices(),!this._addStoryView){const{default:r}=await c(async()=>{const{default:o}=await import("./AddStoryView-wRXp-cwu.js");return{default:o}},[]);this._addStoryView=r,this._addStoryView.mainContent=this._mainContentElement}const{default:e}=await c(async()=>{const{default:r}=await import("./AddStoryPresenter-Cy-DCv_O.js");return{default:r}},[]),t=e(this._storyModel,this._addStoryView,this,this._mapService,this._cameraService,h);return t.showAddStoryForm(),t},async _buildSavedStoriesPresenter(){if(!this._authModel.isUserLoggedIn())return this.navigateTo("login"),null;if(await this._loadStoryModel(),!this._savedStoriesView){const{default:r}=await c(async()=>{const{default:o}=await import("./SavedStoriesView-DEfIPv_E.js");return{default:o}},[]);this._savedStoriesView=r,this._savedStoriesView.mainContent=this._mainContentElement}const{default:e}=await c(async()=>{const{default:r}=await import("./SavedStoriesPresenter-D_0tkKbe.js");return{default:r}},[]),t=e(this._storyModel,this._savedStoriesView,this,h);return await t.showSavedStories(!0),t},async _buildFavoritesPresenter(){if(!this._authModel.isUserLoggedIn())return this.navigateTo("login"),null;await this._loadStoryModel();const{default:e}=await c(async()=>{const{default:a}=await import("./FavoritesView-C9RfvELd.js");return{default:a}},[]),t=e;t.mainContent=this._mainContentElement;const{default:r}=await c(async()=>{const{default:a}=await import("./FavoritesPresenter-gu82F_7I.js");return{default:a}},[]),o=r(this._storyModel,this._authModel,t);return await o.showFavorites(),o},_buildNotFoundPresenter(){if(this._mainContentElement){this._mainContentElement.innerHTML=`
        <section class="error-page-container">
          <h1 class="error-title-404">404</h1>
          <h2 class="section-title">Halaman Tidak Ditemukan</h2>
          <p class="error-message">Maaf, halaman yang Anda cari tidak ada.</p>
          <a href="#" class="btn btn-primary back-to-home-btn" data-route="home">Kembali ke Beranda</a>
        </section>`;const e=this._mainContentElement.querySelector(".back-to-home-btn");e&&e.addEventListener("click",t=>{t.preventDefault(),this.navigateTo("home")})}return{destroy:()=>console.log("NotFoundPresenter destroyed.")}},_handleLogoutRoute(){var e;return(e=this._currentPresenter)!=null&&e.destroy&&this._currentPresenter.destroy(),this._currentPresenter=null,this._authModel.logout(),h.showMessage("Logout Berhasil","Anda telah berhasil keluar."),this.navigateTo("login"),null},async _handleRouteChange(){var i,l;const e=window.location.hash.slice(1)||(this._authModel.isUserLoggedIn()?"home":"login");let t=e.split("/")[0];const r=e.split("/").slice(1),o=["home","add-story","saved-stories"],a=["login","register"];if(o.includes(t)&&!this._authModel.isUserLoggedIn()){this.navigateTo("login");return}if(a.includes(t)&&this._authModel.isUserLoggedIn()){this.navigateTo("home");return}(i=this._currentPresenter)!=null&&i.destroy&&this._currentPresenter.destroy(),this._currentPresenter=null;const n=this._routes[t],s=async()=>{typeof n=="function"?this._currentPresenter=await n(r):(this._currentPresenter=this._buildNotFoundPresenter(),this._updateActiveNavLink(""))};document.startViewTransition?await document.startViewTransition(s):await s(),this._updateNavbar(),(l=this._mainContentElement)!=null&&l.focus&&this._mainContentElement.focus()},navigateTo(e,t=!1){const r=window.location.hash.slice(1).split("/")[0];t||r!==e||window.location.hash.slice(1)!==e?window.location.hash=e:this._handleRouteChange()},_setupGlobalNavLinks(){const e=document.querySelector("#app-header .nav-container");e&&e.addEventListener("click",t=>{const r=t.target.closest("a[data-route]");r&&(t.preventDefault(),this.navigateTo(r.dataset.route))})},_updateActiveNavLink(e){document.querySelectorAll("#nav-links-container .nav-link").forEach(t=>{t.classList.toggle("active",t.dataset.route===e)})},_updateNavbar(){const e=document.getElementById("nav-links-container");if(!e)return;const t=this._authModel.isUserLoggedIn(),r=this._authModel.getCurrentUserName();let o="";t?o=`
    <li><a href="#home" class="nav-link" data-route="home"><i class="fas fa-home"></i> Beranda</a></li>
    <li><a href="#add-story" class="nav-link" data-route="add-story"><i class="fas fa-plus-circle"></i> Tambah</a></li>
    <li><a href="#favorites" class="nav-link" data-route="favorites"><i class="fas fa-star"></i> Favorit</a></li>
    <li><a href="#saved-stories" class="nav-link" data-route="saved-stories"><i class="fas fa-save"></i> Tersimpan</a></li>
    <li><a href="#logout" class="nav-link" data-route="logout"><i class="fas fa-sign-out-alt"></i> Logout (${r||"User"})</a></li>
  `:o=`
        <li><a href="#login" class="nav-link" data-route="login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
        <li><a href="#register" class="nav-link" data-route="register"><i class="fas fa-user-plus"></i> Register</a></li>
      `,e.innerHTML=o;const a=window.location.hash.slice(1)||(t?"home":"login");this._updateActiveNavLink(a.split("/")[0])},async _trySyncOutbox(){var e;if(!(!this._authModel.isUserLoggedIn()||!navigator.onLine))try{if(await this._loadStoryModel(),!((e=this._storyModel)!=null&&e.syncOutboxStories))return;const t=await this._storyModel.syncOutboxStories();t.synced>0&&(h.showMessage("Sinkronisasi Selesai",`${t.synced} cerita dari outbox berhasil diunggah.`),window.location.hash.includes("home")&&this.navigateTo("home"))}catch(t){console.error("Router: Gagal menjalankan sinkronisasi outbox otomatis:",t)}}};async function T(){if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.register("/proyek-akhir/service-worker.js",{scope:"/proyek-akhir/"});console.log("âœ… Service Worker registered:",e.scope),e.active&&(v(e),A(e))}catch(e){console.error("âŒ Failed to register Service Worker:",e)}}async function v(e){var a;if(!("PushManager"in window)||await Notification.requestPermission()!=="granted")return;const o=C("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk");try{const n=await e.pushManager.getSubscription();if(n){const f=(a=n.options)==null?void 0:a.applicationServerKey;f&&o&&M(new Uint8Array(f),new Uint8Array(o))||(console.log("ðŸ” Unsubscribing old push subscription..."),await n.unsubscribe())}const s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:o});console.log("âœ… User subscribed to push:",s);const i=localStorage.getItem("storyAppToken");if(!i){console.warn("â— Token tidak ditemukan, tidak bisa subscribe ke server.");return}const l=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({endpoint:s.endpoint,keys:{p256dh:btoa(String.fromCharCode(...new Uint8Array(s.getKey("p256dh")))),auth:btoa(String.fromCharCode(...new Uint8Array(s.getKey("auth"))))}})}),m=await l.json();if(!l.ok)throw new Error(m.message||"Gagal simpan subscription");console.log("ðŸ“¡ Subscription berhasil dikirim ke server:",m)}catch(n){console.error("âŒ Gagal subscribe user:",n)}}function A(e){const t=document.getElementById("subscribePushBtn"),r=document.getElementById("unsubscribePushBtn"),o=document.getElementById("push-controls");if(!localStorage.getItem("token")||!o){o==null||o.classList.add("hidden");return}o.classList.remove("hidden"),t==null||t.addEventListener("click",async()=>{await v(e),t.classList.add("hidden"),r.classList.remove("hidden")}),r==null||r.addEventListener("click",async()=>{const n=await e.pushManager.getSubscription();n&&(await n.unsubscribe(),console.log("ðŸ”• Berhasil unsubscribe")),r.classList.add("hidden"),t.classList.remove("hidden")})}function M(e,t){return!e||!t||e.length!==t.length?!1:e.every((r,o)=>r===t[o])}function C(e){const t="=".repeat((4-e.length%4)%4),r=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(r);return Uint8Array.from([...o].map(a=>a.charCodeAt(0)))}document.addEventListener("DOMContentLoaded",()=>{L.init("main-content"),T()});export{g as C,w as S,u as T,h as U,c as _};
